Fn::FindInMap
Fn::FindInMap
Fn::FindInMap

Outputs - stack cloudfomration template

Export - link CloudFormation template together

!ImportValue
!ImportValue
!ImportValue

Environment dev/test/prod

Condition: CreateProdResources: !Equals [!Ref EnvType, prod]
ONLY True if the EnvironmentType equals to Prod (Production)

    - And
    - Equals
    - If
    - Not
    - Or

Resources:
    MountPoint:
        Type: AWS::EC2::VolumeAttachment
        Condition: CreateProdResources

Ref

GetAtt

    !GetAtt logicalNameOfResource.attributeName
    !GetAtt myELB.DNSName

    !GetAtt MyInstance.AvailabilityZone
    !GetAtt MyInstance.PrivateDnsName
    !GetAtt MyInstance.PrivateIp
    !GetAtt MyInstance.PublicDnsName
    !GetAtt MyInstance.PublicIp

FindInMap

    !FindInMap [RegionMap, !Ref "AWS::Region", 32]
    !FindInMap [RegionMap, !Ref "AWS::Region", 64]

ImportValue

    !ImportValue SecurityGroupSSH

Join

    !Join [delimiter. [comma-delimited list of values]]
    !Join [":", [a, b, c]]

Sub

    ${VariableName}

Condition: If Not Equals, and etc

    CreateProdResources: !Equals [!Ref EnvType, prod]

        - And
        - Equals
        - If
        - Not
        - Or

Fn::Base64

User data script log -> /var/log/cloud-init-output.log

This is great way to debug from /var/log/cloud-init-output.log

AWS::CloudFormation::Init

    -> /var/log/cfn-init.log

Run cfn-init -> Retrieve init data

CloudFormation cfn-init is way more readable and user-friendly compared to just using UserData

| vertical pipe -> much more indepth and readability

Return EVERYTHING - hardly readable
    
    ðŸ’² cat /var/log/cloud-init-output.log

Focus on the output of our cfn-init script

    ðŸ’² cat /var/log/cfn-init.log

    ðŸ’² cat /var/log/cfn-init-cmd.log

Stack Creation Fails:

    OnFailure=ROLLBACK
    OnFailure=DO_NOTHING # DO_NOTHING let us to SSH and debug what's wrong with our stack
    OnFailure=DELETE

ðŸš€ https://docs.aws.amazon.com/cli/latest/reference/cloudformation/create-stack.html

    ðŸ…± cd /home/josephyu/AWS/AWS-DevOps/cloudformation/cloudformation-sysops

    âœ… ðŸ’² aws cloudformation create-stack --stack-name myteststack --template-body file://0-just-ec2.yaml

    âœ… ðŸ’²
        aws cloudformation create-stack \
            --stack-name cfn-stack-ec2-jyu \
            --template-body file://0-EC2-JYU.yaml \
            --on-failure DO_NOTHING ðŸ‘ˆðŸŽ‰

        ðŸš€ https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-describing-stacks.html#using-cfn-describing-stacks-describe-stacks

        ðŸ’² aws cloudformation describe-stacks --stack-name cfn-stack-ec2-jyu
        {
            "Stacks": [
                {
                    "StackId": "arn:aws:cloudformation:us-east-1:476533684882:stack/cfn-stack-ec2-jyu/533d4110-87d1-11eb-aebe-0af47575f89b",
                    "StackName": "cfn-stack-ec2-jyu",
                    "CreationTime": "2021-03-18T10:04:27.977Z",
                    "RollbackConfiguration": {},
                    "StackStatus": "CREATE_COMPLETE",
                    "DisableRollback": true,  ðŸ‘ˆðŸŽ‰
                    "NotificationARNs": [],
                    "Tags": [],
                    "EnableTerminationProtection": false,
                    "DriftInformation": {
                        "StackDriftStatus": "NOT_CHECKED"
                    }
                }
            ]
        }

ðŸš€ https://aws.amazon.com/blogs/devops/passing-parameters-to-cloudformation-stacks-with-the-aws-cli-and-powershell/
    
    âœ… ðŸ’² 

    $ aws cloudformation create-stack \
    â†’ --stack-name cfn-nestedstack-jyu \
    â†’ --template-body file://7-nestedstacks.yaml \
    â†’ --parameters ParameterKey=SSHKey,ParameterValue=AWSDevOps
    
    aws cloudformation create-stack \
    --stack-name cfn-stack-ec2-jyu \
    --template-body file://0-EC2-JYU.yaml \
    --tags Key=StaffID,Value=320448

    $ aws cloudformation create-stack \
    â†’ --stack-name cfn-stack-ec2-jyu \
    â†’ --template-body file://0-EC2-JYU.yaml \
    â†’ --tags Key=StaffID,Value=320448

    {
        "StackId": "arn:aws:cloudformation:us-east-1:476533684882:stack/cfn-stack-ec2-jyu/ef9685b0-87e2-11eb-a76e-0a8a0480d74d"
    }


DeletionPolicy=Retain

DeletionPolicy=Snapshot

DeletionPolicy=Delete

aws cloudformation create-stack \
--stack-name cfn-deletionpolicy-2-jyu \
--template-body file://9-deletionpolicy-jyu.yaml \
--tags Key=StaffID,Value=320448

aws cloudformation delete-stack --stack-name cfn-deletionpolicy-jyu

